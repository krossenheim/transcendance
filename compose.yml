services:
  nginx:
    container_name: nginx
    image: nginx
    env_file:
      - ./srcs/globals.env
      - ./srcs/nginx/site.env
    build:
      context: .
      dockerfile: ./srcs/nginx/Dockerfile.modsec
      args:
        - SERVICE_NAME=nginx
    healthcheck:
      test: ["CMD-SHELL", "nginx -V 2>&1 | grep -q modsecurity && curl -k -s -o /dev/null 'https://localhost/?q=union%20select' && sleep 0.5 && grep -q '910100' /var/log/modsecurity/modsec_audit.log || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 20s
    restart: always
    ports:
      - "443:443"
    networks:
      transcendance_network:
        ipv4_address: ${NGINX_IPV4_ADDRESS}

  hub:
    container_name: ${HUB_NAME}
    image: ${HUB_NAME}
    env_file:
      - ./srcs/globals.env
      - ./srcs/${HUB_NAME}/service_env.env
    build:
      context: .
      dockerfile: ./srcs/${HUB_NAME}/Dockerfile
      args:
        - SERVICE_NAME=${HUB_NAME}
    restart: always
    networks:
      transcendance_network:
        ipv4_address: ${HUB_IPV4_ADDRESS}

  chat:
    container_name: ${CHATROOM_NAME}
    image: ${CHATROOM_NAME}
    env_file:
      - ./srcs/globals.env
      - ./srcs/${CHATROOM_NAME}/service_env.env
    build:
      context: .
      dockerfile: ./srcs/${CHATROOM_NAME}/Dockerfile
      args:
        - SERVICE_NAME=${CHATROOM_NAME}
    restart: always
    networks:
      transcendance_network:
        ipv4_address: ${CHATROOM_IPV4_ADDRESS}
    depends_on:
      hub:
        condition: service_healthy

  db:
    container_name: ${DATABASE_NAME}
    image: ${DATABASE_NAME}
    env_file:
      - ./srcs/globals.env
      - ./srcs/${DATABASE_NAME}/service_env.env
    build:
      context: .
      dockerfile: ./srcs/${DATABASE_NAME}/Dockerfile
      args:
        - SERVICE_NAME=${DATABASE_NAME}
    restart: always
    networks:
      transcendance_network:
        ipv4_address: ${DATABASE_IPV4_ADDRESS}
    depends_on:
      hub:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "code=$(curl -sS -o /dev/null -w '%{http_code}' http://localhost:3000/ || echo 000); [ \"$code\" != \"000\" ]"]
      interval: 10s
      timeout: 2s
      retries: 5
      start_period: 5s
    volumes:
      - databases:/etc/database_data

  auth:
    container_name: ${AUTH_NAME}
    image: ${AUTH_NAME}
    env_file:
      - ./srcs/globals.env
      - ./srcs/${AUTH_NAME}/service_env.env
    build:
      context: .
      dockerfile: ./srcs/${AUTH_NAME}/Dockerfile
      args:
        - SERVICE_NAME=${AUTH_NAME}
    restart: always
    networks:
      transcendance_network:
        ipv4_address: ${AUTH_IPV4_ADDRESS}
    depends_on:
      hub:
        condition: service_healthy
      db:
        condition: service_healthy

  pong:
    container_name: ${PONG_NAME}
    image: ${PONG_NAME}
    env_file:
      - ./srcs/globals.env
      - ./srcs/${PONG_NAME}/service_env.env
    build:
      context: .
      dockerfile: ./srcs/${PONG_NAME}/Dockerfile
      args:
        - SERVICE_NAME=${PONG_NAME}
    restart: always
    depends_on:
      hub:
        condition: service_healthy
      hardhat:
        condition: service_healthy
      db:
        condition: service_healthy
    networks:
      transcendance_network:
        ipv4_address: ${PONG_IPV4_ADDRESS}

  users:
    container_name: ${USERS_NAME}
    image: ${USERS_NAME}
    env_file:
      - ./srcs/globals.env
      - ./srcs/${USERS_NAME}/service_env.env
    build:
      context: .
      dockerfile: ./srcs/${USERS_NAME}/Dockerfile
      args:
        - SERVICE_NAME=${USERS_NAME}
    restart: always
    depends_on:
      hub:
        condition: service_healthy
      db:
        condition: service_healthy
    networks:
      transcendance_network:
        ipv4_address: ${USERS_IPV4_ADDRESS}

  hardhat:
    container_name: hardhat
    image: hardhat:local
    build:
      context: ../blockchain
      dockerfile: Dockerfile
    restart: always
    ports:
      - "8545:8545"
    networks:
      transcendance_network:
        ipv4_address: ${HARDHAT_IPV4_ADDRESS}
    healthcheck:
      test: ["CMD-SHELL", "curl -sf -X POST -H 'Content-Type: application/json' --data '{\"jsonrpc\":\"2.0\",\"method\":\"eth_blockNumber\",\"params\":[],\"id\":1}' http://localhost:8545 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 20s

  blockchain-explorer:
    container_name: blockchain-explorer
    image: blockchain-explorer:local
    build:
      context: ../blockchain/explorer
      dockerfile: Dockerfile
    restart: always
    environment:
      - RPC_URL=http://hardhat:8545
    ports:
      - "5100:5100"
    networks:
      transcendance_network:
        ipv4_address: ${EXPLORER_IPV4_ADDRESS}
    depends_on:
      hardhat:
        condition: service_healthy

volumes:
  databases:
    name: databases
    driver_opts:
      type: none
      o: bind
      device: ${VOLUMES_DIR}
  esdata:
    driver: local

networks:
  transcendance_network:
    name: transcendance_network
    external: true
  default:
    name: transcendance_network
    external: true