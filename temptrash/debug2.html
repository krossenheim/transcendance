<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Pong Balls Viewer</title>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  </head>
  <body class="bg-gray-900 text-gray-100 flex flex-col items-center justify-center h-screen font-mono">
    <!-- Control Panel -->
    <div class="flex items-center gap-4 mb-4 bg-gray-800 px-4 py-2 rounded-2xl shadow-lg border border-gray-700">
      <label for="boardId" class="text-sm font-semibold">Board ID</label>
      <input
        type="number"
        id="boardId"
        min="1"
        value="1"
        class="w-20 px-2 py-1 rounded-lg bg-gray-700 text-gray-100 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-yellow-400"
      />
      <p class="text-xs text-gray-400">Press <span class="font-bold text-yellow-400">W</span> = Up/Left, <span class="font-bold text-yellow-400">S</span> = Down/Right</p>
    </div>

    <!-- Game Canvas -->
    <div class="relative">
      <canvas
        id="c"
        width="800"
        height="480"
        class="rounded-2xl border-4 border-yellow-500 shadow-2xl"
        style="background: radial-gradient(circle at center, #111 0%, #000 100%)"
      ></canvas>
      <!-- Glow Overlay -->
      <div class="pointer-events-none absolute inset-0 rounded-2xl bg-gradient-to-tr from-yellow-500/10 via-transparent to-yellow-400/10 blur-2xl"></div>
    </div>

    <script type="module">
      import ws from "/static/websocket.js";
      const ctx = document.getElementById("c").getContext("2d");
      const canvas = document.getElementById("c");

      const backendWidth = 1000;
      const backendHeight = 1000;

      let paddles = [];
      let balls = [];

      function mapToCanvas(x, y) {
        const scaleX = canvas.width / backendWidth;
        const scaleY = canvas.height / backendHeight;
        return { cx: x * scaleX, cy: y * scaleY };
      }

      function isBall(obj) {
        return obj && typeof obj.x === "number" && typeof obj.y === "number";
      }
      function isPaddle(obj) {
        return obj && typeof obj.x === "number" && typeof obj.y === "number";
      }

      ws.onmessage = (e) => {
        try {
          if (!e.data.includes("DEBUG")) console.log(e.data);
          const data = JSON.parse(e.data);
          if (data?.balls) balls = data.balls.filter(isBall);
          if (data?.paddles) paddles = data.paddles.filter(isPaddle);
        } catch (err) {
          if (!e.data.includes("DEBUG")) console.error(err);
        }
      };

      function drawGlowBall(x, y, color) {
        const gradient = ctx.createRadialGradient(x, y, 2, x, y, 12);
        gradient.addColorStop(0, color);
        gradient.addColorStop(1, "transparent");
        ctx.fillStyle = gradient;
        ctx.beginPath();
        ctx.arc(x, y, 12, 0, Math.PI * 2);
        ctx.fill();

        ctx.fillStyle = color;
        ctx.beginPath();
        ctx.arc(x, y, 5, 0, Math.PI * 2);
        ctx.fill();
      }

      function drawGlowPaddle(cx, cy, len, angle, color) {
        ctx.save();
        ctx.translate(cx, cy);
        ctx.rotate(angle);

        const gradient = ctx.createLinearGradient(-4, -len / 2, 4, len / 2);
        gradient.addColorStop(0, color);
        gradient.addColorStop(1, "transparent");

        ctx.fillStyle = gradient;
        ctx.shadowColor = color;
        ctx.shadowBlur = 15;
        ctx.fillRect(-4, -len / 2, 8, len);

        ctx.restore();
      }

      function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        balls.forEach((b) => {
          const { cx, cy } = mapToCanvas(b.x, b.y);
          drawGlowBall(cx, cy, "#facc15"); // neon yellow
        });

        paddles.forEach((p) => {
          const { cx, cy } = mapToCanvas(p.x, p.y);
          const len = p.l * (canvas.height / backendHeight);
          const angle = Math.atan2(p.dy, p.dx);
          drawGlowPaddle(cx, cy, len, angle, "#3b82f6"); // neon blue
        });

        requestAnimationFrame(draw);
      }
      draw();

      // Key handling
      const keyState = { w: false, s: false };
      function handleKeyChange(boardId, key, pressed) {
        const prevState = keyState[key];
        keyState[key] = pressed;
        if (prevState !== pressed) {
          let move = null;
          if (key === "w") move = pressed ? false : null;
          if (key === "s") move = pressed ? true : null;
          const payload = { funcId: "/api/pong/move_paddle", b: boardId, m: move };
          runMovePaddle(payload);
        }
      }
      function runMovePaddle(payload) {
        console.log("Paddle move:", payload);
        ws.send(JSON.stringify(payload));
      }

      document.addEventListener("keydown", (e) => {
        if (e.key === "w" || e.key === "s") {
          const boardId = parseInt(document.getElementById("boardId").value, 10);
          handleKeyChange(boardId, e.key, true);
        }
      });
      document.addEventListener("keyup", (e) => {
        if (e.key === "w" || e.key === "s") {
          const boardId = parseInt(document.getElementById("boardId").value, 10);
          handleKeyChange(boardId, e.key, false);
        }
      });
    </script>
  </body>
</html>
