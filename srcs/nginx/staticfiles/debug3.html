<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Pong Balls Viewer ðŸ”¥</title>
    <script type="module" src="/static/websocket.js"></script>
    <style>
      body {
        margin: 0;
        font-family: "Segoe UI", Roboto, sans-serif;
        background: radial-gradient(circle at center, #111 0%, #000 100%);
        color: #eee;
        display: flex;
        flex-direction: column;
        align-items: center;
        height: 100vh;
      }
      header {
        display: flex;
        gap: 1rem;
        align-items: center;
        margin: 1rem 0;
        padding: 0.5rem 1rem;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        box-shadow: 0 0 12px rgba(255, 150, 0, 0.5);
      }
      label {
        font-weight: 600;
      }
      input {
        background: #222;
        border: 1px solid #444;
        border-radius: 6px;
        padding: 0.3rem 0.6rem;
        color: #f90;
        width: 4rem;
        text-align: center;
      }
      p {
        margin: 0.5rem 0 1rem 0;
        font-size: 0.9rem;
        opacity: 0.8;
      }
      canvas {
        border-radius: 16px;
        box-shadow: 0 0 20px rgba(255, 140, 0, 0.8), 0 0 50px rgba(255, 0, 0, 0.3);
        border: 2px solid #f50;
      }
    </style>
  </head>
  <body>
    <header>
      <label for="boardId">Board ID:</label>
      <input type="number" id="boardId" min="1" value="1" />
    </header>
    <p>ðŸ”¥ Press <strong>W</strong> to move up/left & <strong>S</strong> to move down/right ðŸ”¥</p>
    <canvas id="c" width="800" height="480"></canvas>

    <script type="module">
      import ws from "/static/websocket.js";
      const ctx = document.getElementById("c").getContext("2d");
      const canvas = document.getElementById("c");

      const backendWidth = 1000;
      const backendHeight = 1000;

      let paddles = [];
      let balls = [];

      function mapToCanvas(x, y) {
        const scaleX = canvas.width / backendWidth;
        const scaleY = canvas.height / backendHeight;
        return { cx: x * scaleX, cy: y * scaleY };
      }

      function isBall(obj) {
        return obj && typeof obj.x === "number" && typeof obj.y === "number";
      }

      function isPaddle(obj) {
        return obj && typeof obj.x === "number" && typeof obj.y === "number";
      }

      ws.onmessage = (e) => {
        try {
          if (!e.data.includes("DEBUG")) console.log(e.data);
          const data = JSON.parse(e.data);
          if (data && Array.isArray(data.balls)) {
            balls = data.balls.filter(isBall);
          }
          if (data && Array.isArray(data.paddles)) {
            paddles = data.paddles.filter(isPaddle);
          }
        } catch (err) {
          if (!e.data.includes("DEBUG")) console.error(err);
        }
      };

      function drawFireGlow(x, y, radius) {
        const gradient = ctx.createRadialGradient(x, y, 0, x, y, radius * 2);
        gradient.addColorStop(0, "rgba(255,200,0,0.8)");
        gradient.addColorStop(0.5, "rgba(255,100,0,0.4)");
        gradient.addColorStop(1, "rgba(0,0,0,0)");
        ctx.fillStyle = gradient;
        ctx.beginPath();
        ctx.arc(x, y, radius * 2, 0, Math.PI * 2);
        ctx.fill();
      }

      function draw() {
        ctx.fillStyle = "#000";
        ctx.fillRect(0, 0, ctx.canvas.width, ctx.canvas.height);

        balls.forEach((b) => {
          const { cx, cy } = mapToCanvas(b.x, b.y);
          drawFireGlow(cx, cy, 12);
          ctx.beginPath();
          ctx.arc(cx, cy, 6, 0, Math.PI * 2);
          ctx.fillStyle = "orange";
          ctx.shadowBlur = 20;
          ctx.shadowColor = "red";
          ctx.fill();
          ctx.shadowBlur = 0;
        });

        paddles.forEach((p) => {
          const { cx, cy } = mapToCanvas(p.x, p.y);
          const len = p.l * (canvas.height / backendHeight);
          const width = 12;
          const angle = Math.atan2(p.dy, p.dx);

          ctx.save();
          ctx.translate(cx, cy);
          ctx.rotate(angle);

          const grad = ctx.createLinearGradient(-width / 2, -len / 2, width / 2, len / 2);
          grad.addColorStop(0, "#ff3");
          grad.addColorStop(1, "#f30");

          ctx.fillStyle = grad;
          ctx.shadowBlur = 20;
          ctx.shadowColor = "orangered";
          ctx.fillRect(-width / 2, -len / 2, width, len);
          ctx.shadowBlur = 0;

          ctx.restore();
        });

        requestAnimationFrame(draw);
      }
      draw();

      const keyState = { w: false, s: false };

      function handleKeyChange(boardId, key, pressed) {
        const prevState = keyState[key];
        keyState[key] = pressed;
        if (prevState !== pressed) {
          let move = null;
          if (key === "w") move = pressed ? false : null;
          if (key === "s") move = pressed ? true : null;
          const payload = { endpoint: "/api/pong/move_paddle", b: boardId, m: move };
          runMovePaddle(payload);
        }
      }

      function runMovePaddle(payload) {
        console.log("Paddle move:", payload);
        ws.send(JSON.stringify(payload));
      }

      document.addEventListener("keydown", (e) => {
        if (e.key === "w" || e.key === "s") {
          const boardId = parseInt(document.getElementById("boardId").value, 10);
          handleKeyChange(boardId, e.key, true);
        }
      });

      document.addEventListener("keyup", (e) => {
        if (e.key === "w" || e.key === "s") {
          const boardId = parseInt(document.getElementById("boardId").value, 10);
          handleKeyChange(boardId, e.key, false);
        }
      });
    </script>
  </body>
</html>
