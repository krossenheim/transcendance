<!DOCTYPE html>
<html lang="en">
<meta charset="utf-8" />
<title>Pong Balls Viewer</title>
<label for="boardId">Board ID:</label>
<input type="number" id="boardId" min="1" value="1">
<p>Press "W" to move up/left and "S" to move down/right.</p>
<canvas id="c" width="800" height="480" style="background: #000"></canvas>

<script type="module">
import ws from "/static/websocket.js";
const ctx = document.getElementById("c").getContext("2d");
const canvas = document.getElementById("c");

const backendWidth = 1000; 
const backendHeight = 1000;

let balls = [];
let paddles = [];

// map backend coordinates to canvas
function mapToCanvas(x, y) {
  const scaleX = canvas.width / backendWidth;
  const scaleY = canvas.height / backendHeight;
  return { cx: x * scaleX, cy: y * scaleY };
}

ws.onmessage = (e) => {
  try {
    const data = JSON.parse(e.data);

    if (data && Array.isArray(data.balls)) balls = data.balls;
    if (data && Array.isArray(data.paddles)) paddles = data.paddles;

  } catch (err) {
    console.error(err);
  }
};

function draw() {
  ctx.fillStyle = "#000";
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  // Draw balls
  balls.forEach((b) => {
    const { cx, cy } = mapToCanvas(b.x, b.y);
    ctx.beginPath();
    ctx.arc(cx, cy, b.r, 0, Math.PI * 2);
    ctx.fillStyle = "yellow";
    ctx.fill();
  });

  // Draw paddles
  paddles.forEach((p) => {
    const { cx, cy } = mapToCanvas(p.x, p.y);
    const len = p.l * (canvas.height / backendHeight); // scale length
    const width = 8; // paddle width in canvas pixels
    const angle = p.r; // use rotation from backend directly

    ctx.save();
    ctx.translate(cx, cy);
    ctx.rotate(angle);
    ctx.fillStyle = "blue";
    ctx.fillRect(-width / 2, -len / 2, width, len);
    ctx.restore();
  });

  requestAnimationFrame(draw);
}
draw();

// Track key states
const keyState = { w: false, s: false };

function handleKeyChange(boardId, key, pressed) {
  const prevState = keyState[key];
  keyState[key] = pressed;

  if (prevState !== pressed) {
    let move = null;
    if (key === "w") move = pressed ? false : null;
    if (key === "s") move = pressed ? true : null;

    const payload = { endpoint: "/api/pong/move_paddle", b: boardId, m: move };
    runMovePaddle(payload);
  }
}

function runMovePaddle(payload) {
  console.log("Paddle move:", payload);
  ws.send(JSON.stringify(payload));
}

document.addEventListener("keydown", (e) => {
  if (e.key === "w" || e.key === "s") {
    const boardId = parseInt(document.getElementById("boardId").value, 10);
    handleKeyChange(boardId, e.key, true);
  }
});

document.addEventListener("keyup", (e) => {
  if (e.key === "w" || e.key === "s") {
    const boardId = parseInt(document.getElementById("boardId").value, 10);
    handleKeyChange(boardId, e.key, false);
  }
});
</script>
