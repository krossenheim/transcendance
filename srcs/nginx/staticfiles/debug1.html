<!DOCTYPE html>
<html lang="en">
  <meta charset="utf-8" />
  <title>Pong Balls Viewer</title>
  <label for="boardId">Board ID:</label>
  <input type="number" id="boardId" min="1" value="1" />
  <p>Press "W" to move up/left and "S" to move down/right.</p>
  <canvas id="c" width="600" height="600" style="background: #000"></canvas>

  <script type="module">
    import ws from "/static/websocket.js";
    const ctx = document.getElementById("c").getContext("2d");
    const canvas = document.getElementById("c");

    const backendWidth = 1000;
    const backendHeight = 1000;

    let balls = [];
    let paddles = [];

    // map backend coordinates to canvas
    function mapToCanvas(x, y) {
      const scaleX = canvas.width / backendWidth;
      const scaleY = canvas.height / backendHeight;
      return { cx: x * scaleX, cy: y * scaleY };
    }

    ws.onmessage = (e) => {
      try {
        const data = JSON.parse(e.data);

        if (data && Array.isArray(data.balls)) balls = data.balls;
        if (data && Array.isArray(data.paddles)) paddles = data.paddles;
      } catch (err) {
        console.error(err);
      }
    };

    function draw() {
      ctx.fillStyle = "#000";
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // Draw balls
      balls.forEach((b) => {
        const { cx, cy } = mapToCanvas(b.x, b.y);
        ctx.beginPath();
        const scaleX = canvas.width / backendWidth;
        const scaleY = canvas.height / backendHeight;
        ctx.arc(cx, cy, b.r * Math.min(scaleX, scaleY), 0, Math.PI * 2);
        ctx.fillStyle = "yellow";
        ctx.fill();
      });

      // Draw paddles using polygon points a,b,c,d
      paddles.forEach((p) => {
        const points = [
          mapToCanvas(p.a1, p.a2),
          mapToCanvas(p.b1, p.b2),
          mapToCanvas(p.c1, p.c2),
          mapToCanvas(p.d1, p.d2),
        ];

        ctx.fillStyle = "blue";
        ctx.beginPath();
        ctx.moveTo(points[0].cx, points[0].cy);
        for (let i = 1; i < points.length; i++) {
          ctx.lineTo(points[i].cx, points[i].cy);
        }
        ctx.closePath();
        ctx.fill();
      });

      requestAnimationFrame(draw);
    }
    draw();

    // Track key states
    const keyState = { w: false, s: false };

    function handleKeyChange(boardId, key, pressed) {
      const prevState = keyState[key];
      keyState[key] = pressed;

      if (prevState !== pressed) {
        let move = null;
        if (key === "w") move = pressed ? true : null;
        if (key === "s") move = pressed ? false : null;

        const payload = {
          endpoint: "/api/pong/move_paddle",
          b: boardId,
          m: move,
        };
        runMovePaddle(payload);
      }
    }

    function runMovePaddle(payload) {
      console.log("Paddle move:", payload);
      ws.send(JSON.stringify(payload));
    }

    document.addEventListener("keydown", (e) => {
      if (e.key === "w" || e.key === "s") {
        const boardId = parseInt(document.getElementById("boardId").value, 10);
        handleKeyChange(boardId, e.key, true);
      }
    });

    document.addEventListener("keyup", (e) => {
      if (e.key === "w" || e.key === "s") {
        const boardId = parseInt(document.getElementById("boardId").value, 10);
        handleKeyChange(boardId, e.key, false);
      }
    });
  </script>
</html>
