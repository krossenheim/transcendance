<!DOCTYPE html>
<html lang="en">
  <meta charset="utf-8" />
  <title>Pong Balls Viewer</title>
    <label for="boardId">Board ID:</label>
  <input type="number" id="boardId" min="1" value="1">
  <p>Press "W" to move up/left and "S" to move down/right.</p>
  <canvas id="c" width="800" height="480" style="background: #000"></canvas>
  <script type="module">
    import ws from "/static/websocket.js";
    const ctx = document.getElementById("c").getContext("2d");

    const backendWidth = 1000; // adjust to your server coordinate space
    const backendHeight = 1000;

    const canvas = document.getElementById("c");
    let paddles = [];
    let balls = [];
    // map backend coordinates to canvas
    function mapToCanvas(x, y) {
      const scaleX = canvas.width / backendWidth;
      const scaleY = canvas.height / backendHeight;
      return {
        cx: x * scaleX,
        cy: y * scaleY,
      };
    }

    function isBall(obj) {
      return obj && typeof obj.x === "number" && typeof obj.y === "number";
    }

    function isPaddle(obj) {
      return obj && typeof obj.x === "number" && typeof obj.y === "number";
    }

    ws.onmessage = (e) => {
      try {
        if (!e.data.includes("DEBUG")) console.log(e.data);
        const data = JSON.parse(e.data);

        if (data && Array.isArray(data.balls)) {
          balls = data.balls.filter(isBall);
        }

        if (data && Array.isArray(data.paddles)) {
          paddles = data.paddles.filter(isPaddle);
        }
      } catch (err) {
        if (!e.data.includes("DEBUG")) console.error(err);
      }
    };

    function draw() {
      ctx.fillStyle = "#000";
      ctx.fillRect(0, 0, ctx.canvas.width, ctx.canvas.height);
      balls.forEach((b) => {
        const { cx, cy } = mapToCanvas(b.x, b.y);
        ctx.beginPath();
        ctx.arc(cx, cy, 6, 0, Math.PI * 2);
        ctx.fillStyle = "yellow";
        ctx.fill();
      });

      paddles.forEach((p) => {
        const { cx, cy } = mapToCanvas(p.x, p.y);
        const len = p.l * (canvas.height / backendHeight); // scale length
        const width = p.w; // paddle width in canvas pixels

        // Compute angle from forward vector
        const angle = Math.atan2(p.dy, p.dx);

        ctx.save();
        ctx.translate(cx, cy); // move origin to paddle center
        ctx.rotate(angle); // rotate canvas to align with (dx,dy)
        ctx.fillStyle = "blue";
        ctx.fillRect(-width / 2, -len / 2, width, len); // draw rectangle centered at origin
        ctx.restore();
      });

      requestAnimationFrame(draw);
    }
    draw();

    // Track key states
    const keyState = { w: false, s: false };

    // Handle key changes
    function handleKeyChange(boardId, key, pressed) {
      const prevState = keyState[key];
      keyState[key] = pressed;

      if (prevState !== pressed) {
        // Determine move
        let move = null;
        if (key === "w") move = pressed ? false : null;
        if (key === "s") move = pressed ? true : null;

        const payload = { funcId: "/api/pong/move_paddle", b: boardId, m: move };        
        runMovePaddle(payload);

      }
    }

    // Example function to handle the move
    function runMovePaddle(payload) {
      console.log("Paddle move:", payload);
      ws.send(JSON.stringify(payload));
      // Here you could send payload to server via WebSocket or fetch
    }

    // Event listeners
    document.addEventListener("keydown", (e) => {
      if (e.key === "w" || e.key === "s") {
        const boardId = parseInt(document.getElementById("boardId").value, 10);
        handleKeyChange(boardId, e.key, true);
      }
    });

    document.addEventListener("keyup", (e) => {
      if (e.key === "w" || e.key === "s") {
        const boardId = parseInt(document.getElementById("boardId").value, 10);
        handleKeyChange(boardId, e.key, false);
      }
    });
  </script>
  </script>
</html>
