<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>WebSocket Debug</title>
    <style>
      body {
        font-family: "Segoe UI", sans-serif;
        padding: 20px;
        background: #f7f7f7;
      }
      #outputBox {
        width: 100%;
        height: 200px;
        border: 1px solid #ccc;
        overflow: auto;
        padding: 5px;
        font-family: monospace;
        background: #f9f9f9;
        margin-bottom: 15px;
        white-space: pre-wrap;
        word-wrap: break-word;
      }
      #actions div {
        margin-bottom: 10px;
      }
      input[type="text"] {
        padding: 6px 8px;
        margin-right: 8px;
        font-size: 14px;
        width: 200px;
      }
      button {
        padding: 6px 14px;
        background: #007bff;
        color: white;
        border: none;
        cursor: pointer;
        font-size: 14px;
        border-radius: 4px;
        transition: background 0.2s ease;
      }
      button:hover {
        background: #0056b3;
      }
    </style>
  </head>
  <body>
    <h3>WebSocket Output</h3>
    <div id="outputBox"></div>

    <input id="myInput" type="text" placeholder="Type raw message" />
    <button id="sendBtn">Send characters</button>

    <div id="actions"></div>

    <script type="module">
      import ws from "/static/websocket.js";

      const outputBox = document.getElementById("outputBox");
      const input = document.getElementById("myInput");
      const sendBtn = document.getElementById("sendBtn");
      const actions = [
        {
          name: "sendAddRoom",
          label: "Add Room",
          endpoint: "/api/chat/add_a_new_room",
          fields: { room_name: "Room Name" },
        },
        {
          name: "sendAddToRoom",
          label: "Add To Room",
          endpoint: "/api/chat/add_to_room",
          fields: { room_name: "Room Name", user_to_add: "User ID" },
        },
        {
          name: "sendMessage",
          label: "Send Message",
          endpoint: "/api/chat/send_message_to_room",
          fields: { room_name: "Room Name", message: "Message" },
        },
        {
          name: "startGame",
          label: "startGame",
          endpoint: "/api/pong/start_game",
          fields: { player_list: "player_list" },
        },
      ];

      function logOutput(message) {
        outputBox.innerHTML += message + "\n";
        outputBox.scrollTop = outputBox.scrollHeight;
      }

      sendBtn.addEventListener("click", () => {
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(input.value);
          logOutput("Sent raw: " + input.value);
          input.value = "";
        } else {
          alert("WebSocket is not connected.");
        }
      });

      ws.addEventListener("message", (event) => {
        logOutput("Received: " + event.data);
      });

      const container = document.getElementById("actions");

      actions.forEach((action) => {
        const row = document.createElement("div");

        // Create inputs for each field
        const inputs = {};
        for (const [field, label] of Object.entries(action.fields)) {
          const inputEl = document.createElement("input");
          inputEl.type = "text";
          inputEl.placeholder = label;
          row.appendChild(inputEl);
          inputs[field] = inputEl;
        }

        // Create button for action
        const btn = document.createElement("button");
        btn.textContent = action.label;
        btn.onclick = () => {
          const payload = { endpoint: action.endpoint };
          for (const [field, inputEl] of Object.entries(inputs)) {
            const raw = inputEl.value.trim();

            let val = raw;
            // try number
            const num = Number(raw);
            if (!isNaN(num) && raw !== "") {
              val = num;
            }
            // try array
            else if (/^\[.*\]$/.test(raw)) {
              try {
                const parsed = JSON.parse(raw);
                if (
                  Array.isArray(parsed) &&
                  parsed.every((x) => typeof x === "number")
                ) {
                  val = parsed;
                }
              } catch {
                // fall back to raw string if JSON.parse fails
              }
            }

            payload[field] = val;
          }
          if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify(payload));
            logOutput("Sent JSON: " + JSON.stringify(payload));
            // Clear inputs after send
            Object.values(inputs).forEach((el) => (el.value = ""));
          } else {
            alert("WebSocket is not connected.");
          }
        };
        row.appendChild(btn);

        container.appendChild(row);
      });
    </script>
  </body>
</html>
